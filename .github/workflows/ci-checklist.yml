name: CI Checklist - Pre-Review Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master, main]

jobs:
  # ============================================================
  # Detect what changed
  # ============================================================
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      workflow-only: ${{ steps.changes.outputs.workflow-only }}
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes
        id: changes
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 2>/dev/null || true
          CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}...HEAD || echo "")
          
          if echo "$CHANGED_FILES" | grep -qE '^(backend/|training/)'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No backend changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '^\.github/workflows/' && ! echo "$CHANGED_FILES" | grep -qvE '^\.github/workflows/'; then
            echo "workflow-only=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Only workflow files changed"
          else
            echo "workflow-only=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # CHECKLIST: Installation & Setup
  # ============================================================
  install-frontend:
    name: ‚úÖ Install Frontend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify installation
        run: npm list --depth=0

  install-backend:
    name: ‚úÖ Install Backend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify installation
        working-directory: ./backend
        run: pip list

  # ============================================================
  # CHECKLIST: Code Quality - Linting
  # ============================================================
  lint-frontend:
    name: ‚úÖ Lint Frontend (ESLint)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint || echo "‚ö†Ô∏è  ESLint errors found (non-blocking for now)"
        continue-on-error: true
      
      - name: Check formatting (Prettier)
        run: |
          npm run format -- --check || (echo "‚ùå Code not formatted. Run 'npm run format' to fix." && exit 1)

  lint-backend:
    name: ‚úÖ Lint Backend (Flake8/Ruff)
    runs-on: ubuntu-latest
    needs: [install-backend, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.workflow-only != 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install linting tools
        working-directory: ./backend
        run: |
          pip install flake8 black isort mypy
      
      - name: Run Flake8
        working-directory: ./backend
        run: |
          flake8 rl_studio --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Check code formatting (Black)
        working-directory: ./backend
        run: |
          black --check rl_studio || (echo "‚ö†Ô∏è  Code formatting issues found. Run 'black rl_studio' to fix." && exit 0)
        continue-on-error: true
      
      - name: Check import sorting (isort)
        working-directory: ./backend
        run: |
          isort --check-only rl_studio || (echo "‚ö†Ô∏è  Import sorting issues found. Run 'isort rl_studio' to fix." && exit 0)
        continue-on-error: true

  # ============================================================
  # CHECKLIST: Type Checking
  # ============================================================
  typecheck-frontend:
    name: ‚úÖ Type Check Frontend (TypeScript)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript check
        run: npx tsc --noEmit || echo "‚ö†Ô∏è  TypeScript errors found (non-blocking for now)"
        continue-on-error: true

  typecheck-backend:
    name: ‚úÖ Type Check Backend (mypy)
    runs-on: ubuntu-latest
    needs: [install-backend, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.workflow-only != 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install mypy
      
      - name: Run mypy
        working-directory: ./backend
        run: |
          mypy rl_studio --ignore-missing-imports --no-strict-optional || true

  # ============================================================
  # CHECKLIST: Testing
  # ============================================================
  test-frontend:
    name: ‚úÖ Test Frontend (Vitest)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --run

  test-backend:
    name: ‚úÖ Test Backend (pytest)
    runs-on: ubuntu-latest
    needs: [install-backend, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.workflow-only != 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        working-directory: ./backend
        run: |
          pytest --cov=rl_studio --cov-report=term || (echo "‚ö†Ô∏è  Some tests failed (non-blocking)" && exit 0)
        continue-on-error: true

  # ============================================================
  # CHECKLIST: Build Verification
  # ============================================================
  build-frontend:
    name: ‚úÖ Build Frontend
    runs-on: ubuntu-latest
    needs: [lint-frontend, typecheck-frontend, test-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Verify build output
        run: |
          test -d dist || (echo "‚ùå Build failed: dist directory not found" && exit 1)
          test -f dist/index.html || (echo "‚ùå Build failed: index.html not found" && exit 1)

  build-backend:
    name: ‚úÖ Build Backend (Import Check)
    runs-on: ubuntu-latest
    needs: [lint-backend, typecheck-backend, test-backend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
      
      - name: Verify imports
        working-directory: ./backend
        run: |
          python -c "import rl_studio; print('‚úÖ Backend imports successfully')"

  # ============================================================
  # CHECKLIST: Security & Dependencies
  # ============================================================
  security-scan:
    name: ‚úÖ Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
      
      - name: Run pip audit (if available)
        working-directory: ./backend
        run: |
          pip install pip-audit
          pip-audit --format=json --output=audit.json || true


