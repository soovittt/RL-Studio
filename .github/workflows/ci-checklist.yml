name: CI Checklist - Pre-Review Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================================
  # Detect what changed
  # ============================================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      workflow-only: ${{ steps.changes.outputs.workflow-only }}
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes
        id: changes
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 2>/dev/null || true
          CHANGED_FILES=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}...HEAD || echo "")
          
          if echo "$CHANGED_FILES" | grep -qE '^(backend/|training/)'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No backend changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -qE '^\.github/workflows/' && ! echo "$CHANGED_FILES" | grep -qvE '^\.github/workflows/'; then
            echo "workflow-only=true" >> $GITHUB_OUTPUT
            echo "âœ… Only workflow files changed"
          else
            echo "workflow-only=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # CHECKLIST: Installation & Setup
  # ============================================================
  install-frontend:
    name: âœ… Install Frontend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify installation
        run: npm list --depth=0

  install-backend:
    name: âœ… Install Backend Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify installation
        working-directory: ./backend
        run: pip list

  # ============================================================
  # CHECKLIST: Code Quality - Linting
  # ============================================================
  lint-frontend:
    name: âœ… Lint Frontend (ESLint)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint || echo "âš ï¸  ESLint errors found (non-blocking for now)"
        continue-on-error: true
      
      - name: Check formatting (Prettier)
        run: |
          npm run format -- --check || (echo "âŒ Code not formatted. Run 'npm run format' to fix." && exit 1)

  lint-backend:
    name: âœ… Lint Backend (Flake8/Ruff)
    runs-on: ubuntu-latest
    needs: [install-backend, detect-changes]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.workflow-only != 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install linting tools
        working-directory: ./backend
        run: |
          pip install flake8 black isort mypy
      
      - name: Run Flake8
        working-directory: ./backend
        run: |
          flake8 rl_studio --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Check code formatting (Black)
        working-directory: ./backend
        run: |
          black --check rl_studio || (echo "âŒ Code not formatted. Run 'black rl_studio' to fix." && exit 1)
      
      - name: Check import sorting (isort)
        working-directory: ./backend
        run: |
          isort --check-only rl_studio || (echo "âŒ Imports not sorted. Run 'isort rl_studio' to fix." && exit 1)

  # ============================================================
  # CHECKLIST: Type Checking
  # ============================================================
  typecheck-frontend:
    name: âœ… Type Check Frontend (TypeScript)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript check
        run: npx tsc --noEmit || echo "âš ï¸  TypeScript errors found (non-blocking for now)"
        continue-on-error: true

  typecheck-backend:
    name: âœ… Type Check Backend (mypy)
    runs-on: ubuntu-latest
    needs: install-backend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install mypy
      
      - name: Run mypy
        working-directory: ./backend
        run: |
          mypy rl_studio --ignore-missing-imports --no-strict-optional || true

  # ============================================================
  # CHECKLIST: Testing
  # ============================================================
  test-frontend:
    name: âœ… Test Frontend (Vitest)
    runs-on: ubuntu-latest
    needs: install-frontend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test -- --run

  test-backend:
    name: âœ… Test Backend (pytest)
    runs-on: ubuntu-latest
    needs: install-backend
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        working-directory: ./backend
        run: |
          pytest --cov=rl_studio --cov-report=term

  # ============================================================
  # CHECKLIST: Build Verification
  # ============================================================
  build-frontend:
    name: âœ… Build Frontend
    runs-on: ubuntu-latest
    needs: [lint-frontend, typecheck-frontend, test-frontend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Verify build output
        run: |
          test -d dist || (echo "âŒ Build failed: dist directory not found" && exit 1)
          test -f dist/index.html || (echo "âŒ Build failed: index.html not found" && exit 1)

  build-backend:
    name: âœ… Build Backend (Import Check)
    runs-on: ubuntu-latest
    needs: [lint-backend, typecheck-backend, test-backend]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
      
      - name: Verify imports
        working-directory: ./backend
        run: |
          python -c "import rl_studio; print('âœ… Backend imports successfully')"

  # ============================================================
  # CHECKLIST: Security & Dependencies
  # ============================================================
  security-scan:
    name: âœ… Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
      
      - name: Run pip audit (if available)
        working-directory: ./backend
        run: |
          pip install pip-audit
          pip-audit --format=json --output=audit.json || true

  # ============================================================
  # CHECKLIST: Final Summary (Ready for Review)
  # ============================================================
  checklist-summary:
    name: ðŸ“‹ CI Checklist Summary
    runs-on: ubuntu-latest
    needs: [
      install-frontend,
      install-backend,
      lint-frontend,
      lint-backend,
      typecheck-frontend,
      typecheck-backend,
      test-frontend,
      test-backend,
      build-frontend,
      build-backend,
      security-scan
    ]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate checklist comment
        uses: actions/github-script@v7
        with:
          script: |
            const allJobs = [
              { name: 'install-frontend', display: 'Install Frontend' },
              { name: 'install-backend', display: 'Install Backend' },
              { name: 'lint-frontend', display: 'Lint Frontend' },
              { name: 'lint-backend', display: 'Lint Backend' },
              { name: 'typecheck-frontend', display: 'Type Check Frontend' },
              { name: 'typecheck-backend', display: 'Type Check Backend' },
              { name: 'test-frontend', display: 'Test Frontend' },
              { name: 'test-backend', display: 'Test Backend' },
              { name: 'build-frontend', display: 'Build Frontend' },
              { name: 'build-backend', display: 'Build Backend' },
              { name: 'security-scan', display: 'Security Scan' }
            ];
            
            // Get workflow run info
            const workflowRun = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            // Get all jobs for this run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            let checklist = '## ðŸ” Pre-Review Checklist Status\n\n';
            checklist += '**All checks must pass before this PR is eligible for manual review.**\n\n';
            checklist += '| Check | Status |\n';
            checklist += '|-------|--------|\n';
            
            let allPassed = true;
            
            for (const job of allJobs) {
              const jobRun = jobs.data.jobs.find(j => 
                j.name.toLowerCase().includes(job.name.replace(/-/g, ' ')) ||
                j.name.includes(job.display)
              );
              
              let status = 'â³';
              let emoji = 'â³';
              
              if (jobRun) {
                if (jobRun.conclusion === 'success') {
                  status = 'âœ… Pass';
                  emoji = 'âœ…';
                } else if (jobRun.conclusion === 'failure') {
                  status = 'âŒ Fail';
                  emoji = 'âŒ';
                  allPassed = false;
                } else if (jobRun.conclusion === 'cancelled') {
                  status = 'ðŸš« Cancelled';
                  emoji = 'ðŸš«';
                  allPassed = false;
                } else {
                  status = 'â³ Running';
                  emoji = 'â³';
                }
              }
              
              checklist += `| ${emoji} ${job.display} | ${status} |\n`;
            }
            
            checklist += '\n---\n\n';
            
            if (allPassed) {
              checklist += 'âœ… **All pre-checks passed!**\n\n';
              checklist += 'ðŸ‘€ **This PR is now ready for manual review by @soovittt**\n\n';
              checklist += 'âš ï¸ **Note:** This PR still requires manual approval before merging.';
            } else {
              checklist += 'âŒ **Some checks failed.**\n\n';
              checklist += 'âš ï¸ **Please fix the failing checks before requesting review.**\n\n';
              checklist += 'Once all checks pass, this PR will be eligible for manual review.';
            }
            
            // Post or update comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Pre-Review Checklist Status')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: checklist
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: checklist
              });
            }

