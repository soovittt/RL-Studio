name: Auto Deploy on Merge to Master

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  # Detect what changed
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need previous commit to compare
      
      - name: Detect changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(app/|public/|package\.json|package-lock\.json|vite\.config\.ts|tsconfig\.json|Dockerfile\.frontend|nginx\.conf|cloudbuild-frontend\.yaml|\.github/workflows/auto-deploy\.yml)'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No frontend changes"
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(backend/|training/)'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No backend changes"
          fi

  # Deploy Frontend
  deploy-frontend:
    name: ðŸš€ Deploy Frontend to GCP
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region us-central1
      
      - name: Build and deploy frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_CONVEX_URL: ${{ secrets.VITE_CONVEX_URL }}
          VITE_ROLLOUT_SERVICE_URL: ${{ secrets.VITE_ROLLOUT_SERVICE_URL }}
          VITE_TRAINING_SERVICE_URL: ${{ secrets.VITE_TRAINING_SERVICE_URL }}
        run: |
          echo "ðŸš€ Building and deploying frontend..."
          
          # Build Docker image with Cloud Build
          BUILD_ID=$(gcloud builds submit . \
              --config=cloudbuild-frontend.yaml \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --substitutions=_VITE_API_URL=$VITE_API_URL,_VITE_CONVEX_URL=$VITE_CONVEX_URL,_VITE_ROLLOUT_SERVICE_URL=$VITE_ROLLOUT_SERVICE_URL,_VITE_TRAINING_SERVICE_URL=$VITE_TRAINING_SERVICE_URL \
              --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          
          # Wait for build to complete by polling status
          echo "â³ Waiting for build to complete..."
          MAX_WAIT=1800  # 30 minutes max
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud builds describe $BUILD_ID --project=${{ secrets.GCP_PROJECT_ID }} --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Build completed successfully!"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "EXPIRED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              exit 1
            else
              echo "â³ Build status: $STATUS (waiting...)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            fi
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Build timeout after $MAX_WAIT seconds"
            exit 1
          fi
          
          # Deploy to Cloud Run
          echo "ðŸš€ Deploying to Cloud Run..."
          gcloud run deploy rl-studio-frontend \
              --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/rl-studio-frontend:latest \
              --region us-central1 \
              --allow-unauthenticated \
              --platform managed \
              --memory 1Gi \
              --cpu 1 \
              --timeout 300 \
              --max-instances 10 \
              --min-instances 0 \
              --concurrency 80 \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --set-env-vars "VITE_API_URL=$VITE_API_URL,VITE_CONVEX_URL=$VITE_CONVEX_URL,VITE_ROLLOUT_SERVICE_URL=$VITE_ROLLOUT_SERVICE_URL,VITE_TRAINING_SERVICE_URL=$VITE_TRAINING_SERVICE_URL"
          
          echo "âœ… Frontend deployed successfully!"
          
          # Capture deployed frontend URL and set in Convex
          echo "ðŸ”§ Capturing frontend URL..."
          # Use secret if available, otherwise capture from deployment
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -z "$FRONTEND_URL" ]; then
            FRONTEND_URL=$(gcloud run services describe rl-studio-frontend \
                --region us-central1 \
                --project ${{ secrets.GCP_PROJECT_ID }} \
                --format="value(status.url)" 2>/dev/null || echo "")
          fi
          
          if [ -n "$FRONTEND_URL" ]; then
            echo "âœ… Frontend URL: $FRONTEND_URL"
            echo "ðŸ”§ Setting FRONTEND_URL in Convex environment variables..."
            # Set FRONTEND_URL in Convex (requires Convex CLI to be available)
            # Note: This requires CONVEX_DEPLOY_KEY to be set as a secret
            if [ -n "${{ secrets.CONVEX_DEPLOY_KEY }}" ]; then
              npx convex env set FRONTEND_URL "$FRONTEND_URL" || echo "âš ï¸ Could not set Convex env automatically"
            else
              echo "â„¹ï¸  CONVEX_DEPLOY_KEY not set - FRONTEND_URL is already set in Convex"
              echo "   Current value can be verified with: npx convex env list"
            fi
          else
            echo "âš ï¸ Could not determine frontend URL"
          fi

  # Deploy Backend
  deploy-backend:
    name: ðŸš€ Deploy Backend to GCP
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region us-central1
      
      - name: Build and deploy backend
        working-directory: ./backend
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
        run: |
          echo "ðŸš€ Building and deploying backend..."
          
          # Build Docker image in Google Cloud Build (offload heavy lifting from GitHub runner)
          # Use async submit + manual polling to avoid log streaming permission issues
          IMAGE_NAME="gcr.io/${{ secrets.GCP_PROJECT_ID }}/rl-studio-backend:latest"
          BUILD_ID=$(gcloud builds submit . \
            --tag "$IMAGE_NAME" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --format="value(id)" \
            --async)

          echo "Backend Build ID: $BUILD_ID"
          echo "â³ Waiting for backend build to complete..."

          MAX_WAIT=1800  # 30 minutes max
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud builds describe "$BUILD_ID" --project="${{ secrets.GCP_PROJECT_ID }}" --format="value(status)" 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Backend build completed successfully!"
              break
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ] || [ "$STATUS" = "EXPIRED" ]; then
              echo "âŒ Backend build failed with status: $STATUS"
              exit 1
            else
              echo "â³ Backend build status: $STATUS (waiting...)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            fi
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Backend build timeout after $MAX_WAIT seconds"
            exit 1
          fi
          
          # Deploy to Cloud Run
          echo "ðŸš€ Deploying to Cloud Run..."
          gcloud run deploy rl-studio-backend \
              --image $IMAGE_NAME \
              --region us-central1 \
              --allow-unauthenticated \
              --platform managed \
              --memory 2Gi \
              --cpu 2 \
              --timeout 300 \
              --max-instances 10 \
              --min-instances 0 \
              --concurrency 80 \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --set-env-vars "CONVEX_URL=$CONVEX_URL,OPENAI_API_KEY=$OPENAI_API_KEY,AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY,AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION,CORS_ORIGINS=$CORS_ORIGINS"
          
          echo "âœ… Backend deployed successfully!"

  # Deployment summary
  deployment-summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-frontend, deploy-backend]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
              echo "| Frontend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend | â­ï¸  Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ]; then
            if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
              echo "| Backend | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | â­ï¸  Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully"

